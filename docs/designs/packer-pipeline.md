# Packer Pipeline

Image build, naming, caching, and release integration for homestak packer images.

**Sprint:** #254 (Packer Pipeline)
**Issues:** packer#48, packer#36, packer#46, homestak-dev#253

## Image Naming Convention

Images use stable names that match tofu's `var.images` keys 1:1.

| Template Dir | Output File | Published File | Tofu Key |
|-------------|-------------|----------------|----------|
| `templates/debian-12/` | `debian-12.qcow2` | `debian-12.img` | `debian-12` |
| `templates/debian-13/` | `debian-13.qcow2` | `debian-13.img` | `debian-13` |
| `templates/pve-9/` | `pve-9.qcow2` | `pve-9.img` | `pve-9` |

**Principles:**
- Filename = tofu key + extension. No suffixes, no symlinks.
- Debian images use `debian-{major}`. The major version tracks the Debian release series.
- PVE images use `pve-{major}`. The major version tracks the PVE release series. The underlying Debian version is an implementation detail.
- Point release versions (12.13, 13.3, PVE 9.1) are recorded in metadata, not filenames.

### Version Metadata

Each built image produces a version file alongside it:

```
images/debian-12/
├── debian-12.qcow2
├── debian-12.qcow2.sha256
└── image-version.txt        # DEBIAN_VERSION=12.13
```

The `image-version.txt` file is generated by `shared/scripts/detect-versions.sh` during the build and downloaded by packer. It records:
- `DEBIAN_VERSION` - Debian point release (e.g., `12.13`)
- `PVE_VERSION` - PVE version if installed (e.g., `9.1`)

### Tofu Integration

```hcl
# tofu/envs/generic/variables.tf
variable "images" {
  type    = map(string)
  default = {
    "debian-12" = "local:iso/debian-12.img"
    "debian-13" = "local:iso/debian-13.img"
    "pve-9"     = "local:iso/pve-9.img"
  }
}
```

Manifests reference images by tofu key:
```yaml
# site-config/manifests/n2-tiered.yaml
nodes:
  - name: root-pve
    image: pve-9        # matches tofu key directly
  - name: edge
    image: debian-12    # matches tofu key directly
```

### iac-driver Image Resolution

`_image_to_asset_name()` in `src/actions/pve_lifecycle.py` converts manifest image names to release asset filenames. With stable naming, this simplifies to:

```python
def _image_to_asset_name(image: str) -> str:
    return f"{image}.qcow2"
```

No suffix logic needed — the image name IS the asset basename.

## Build Workflow

```
templates/{name}/template.pkr.hcl
    │
    ▼ ./build.sh {name}
images/{name}/{name}.qcow2          + .sha256, image-version.txt
    │
    ▼ ./publish.sh
/var/lib/vz/template/iso/{name}.img  (qemu-img convert, compressed)
    │
    ▼ tofu apply (via iac-driver)
VM provisioned with image
```

### Build Process

1. `build.sh` downloads the base Debian cloud image to `cache/` (cached)
2. Boots a QEMU VM with cloud-init (NoCloud datasource)
3. Runs `apt-get update && apt-get upgrade -y` to apply all available security patches
4. Installs `qemu-guest-agent` and template-specific packages
5. Runs `detect-versions.sh` to capture version metadata
6. Runs template-specific `cleanup.sh`
7. Outputs `{name}.qcow2` to `images/{name}/`
8. Generates `{name}.qcow2.sha256`

### PVE Image Build

The `pve-9` template starts from the upstream Debian 13 cloud image and installs PVE packages via apt:

```bash
apt-get install -y proxmox-ve postfix open-iscsi chrony
```

This means rebuilding `pve-9` picks up updates from two independent sources:
- **Debian base image refreshes** — upstream security patches
- **PVE repository updates** — new PVE package versions via apt

A marker file (`/etc/pve-packages-preinstalled`) tells ansible to skip PVE installation on VMs built from this image.

### Publish Process

`publish.sh` compresses and copies images to PVE storage:

```bash
qemu-img convert -c -O qcow2 images/{name}/{name}.qcow2 /var/lib/vz/template/iso/{name}.img
```

## Built Image Caching

Skip rebuilding when nothing has changed. Cache validity is determined by a composite key.

### Cache Key

The cache key hashes two components:

1. **Source cloud image checksum** — SHA256 of the base Debian cloud image in `cache/`
2. **Template specification hash** — SHA256 of the combined content of:
   - `templates/{name}/template.pkr.hcl`
   - `templates/{name}/cleanup.sh`
   - `shared/scripts/cleanup-common.sh`
   - `shared/scripts/detect-versions.sh`
   - `shared/cloud-init/user-data.pkrtpl`
   - `shared/cloud-init/meta-data`

### Cache Storage

A `.cache-key` file alongside the built image:

```
images/debian-12/
├── debian-12.qcow2
├── debian-12.qcow2.sha256
├── image-version.txt
└── .cache-key               # composite hash
```

### Cache Behavior

```bash
./build.sh debian-12          # Use cache if valid, rebuild if stale
./build.sh --force debian-12  # Always rebuild regardless of cache
```

On cache hit: `build.sh` prints the cache status and skips the build.
On cache miss: `build.sh` rebuilds and writes a new `.cache-key`.

### Cache Invalidation

The cache automatically invalidates when:
- The upstream cloud image changes (new checksum in `cache/`)
- Any template or shared file is modified
- `--force` flag is passed
- The `.cache-key` file is missing or corrupt

### PVE Image Caveat

The `pve-9` cache key does NOT track PVE repository state — only the template files and base image. PVE package updates via apt happen during the build and aren't reflected in the cache key. Use `--force` when you know PVE packages have been updated upstream. For scheduled rebuilds (#46), always use `--force`.

## Release Integration

### Latest-Centric Model

The `latest` release is the primary source for packer images. Versioned releases are tag-only — they inherit images from `latest`.

See [64-release-packer.md](../lifecycle/64-release-packer.md) for the release phase workflow.

### Upload Workflow

`build.sh` always outputs a single `.qcow2` per template. Splitting for GitHub's 2GB asset limit happens at upload time via `release.sh packer --upload`:

```bash
# Build locally (outputs images/{name}/{name}.qcow2)
cd packer && ./build.sh

# Upload to latest release (auto-splits >2GB images)
cd .. && ./scripts/release.sh packer --upload --execute --all
```

### Release Assets

```
latest release assets:
├── debian-12.qcow2
├── debian-12.qcow2.sha256
├── debian-13.qcow2
├── debian-13.qcow2.sha256
├── pve-9.qcow2.partaa       # Auto-split at upload time (>2GB)
├── pve-9.qcow2.partab
└── pve-9.qcow2.sha256
```

Files >2GB are automatically split into ~1.9GB parts during upload.

### Asset Management

```bash
release.sh packer --upload --execute --all        # Upload all, skip unchanged
release.sh packer --upload --execute --all --force # Upload all, force overwrite
release.sh packer --upload --execute debian-12     # Upload specific template
release.sh packer --remove --execute debian-12     # Remove specific template
release.sh packer --remove --execute --all         # Remove all image assets
```

### Bootstrap Image Download

`homestak images download` fetches release assets and reassembles split files:

```bash
homestak images download all --publish    # Download + install to PVE storage
homestak images list --version v0.50      # List images in specific release
```

## Related Documents

| Document | Focus |
|----------|-------|
| [packer/CLAUDE.md](../../packer/CLAUDE.md) | Template details, build prerequisites, CI/CD |
| [64-release-packer.md](../lifecycle/64-release-packer.md) | Release phase decision tree |
| [tofu/CLAUDE.md](../../tofu/CLAUDE.md) | `var.images` mapping, cloud image modules |
| [bootstrap/CLAUDE.md](../../bootstrap/CLAUDE.md) | `homestak images` CLI |
